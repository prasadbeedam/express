pipeline {
    agent {
        label 'AGENT-1'
    }

    parameters {
        string(name: 'APP_VERSION', defaultValue: '', description: 'Version to deploy (e.g. 1.0.0)')
    }

    environment {
        APP_DIR = "examples/hello-world"
        IMAGE_NAME = "prasadyadav99/hello-world-app"
        NAMESPACE = "hello-world"
        KUBECONFIG = "/home/ec2-user/.kube/config"
    }

    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/prasadbeedam/express.git'
                sh 'git checkout main'
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                dir("${APP_DIR}") {
                    script {
                        def imageTag = "${IMAGE_NAME}:${params.APP_VERSION}"
                        echo "üöÄ Deploying image: ${imageTag}"

                        sh """
                            sed -i 's|image: .*|image: ${imageTag}|' deployment.yaml
                            cat deployment.yaml
                            export KUBECONFIG=${KUBECONFIG}
                            kubectl version --client
                            kubectl apply -n ${NAMESPACE} -f deployment.yaml
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Deployment succeeded for version ${params.APP_VERSION}"
        }
        failure {
            echo "‚ùå Deployment failed. Please check logs and Kubernetes state."
        }
    }
}
